<!DOCTYPE html><html lang="zh-TW" class="loading"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><title>喝杯 Mocha 輕鬆打造 Node.js 的 TDD 生產線 - 淼 Be Water</title><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="google" content="notranslate"><meta name="keywords" content="Web,JavaScript,JS,Nodejs,開發,Development,"><meta name="description" content="Who is Wei Hong-Lin (Ivan Wei),一群人協作就是要測試一下
前言最近在公司導入 TDD，因此將這段程過記錄免得未來不記得怎麼設定。
先說我很愛 TDD (Test-driven development)，簡單幾點原因：

簡單化 -,"><meta name="author" content="Wei Hong-Lin (Ivan Wei)"><link rel="alternative" href="atom.xml" title="淼 Be Water" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="喝杯 Mocha 輕鬆打造 Node.js 的 TDD 生產線 - 淼 Be Water"><meta name="twitter:description" content="Who is Wei Hong-Lin (Ivan Wei),一群人協作就是要測試一下
前言最近在公司導入 TDD，因此將這段程過記錄免得未來不記得怎麼設定。
先說我很愛 TDD (Test-driven development)，簡單幾點原因：

簡單化 -,"><meta property="og:site_name" content="淼 Be Water"><meta property="og:type" content="object"><meta property="og:title" content="喝杯 Mocha 輕鬆打造 Node.js 的 TDD 生產線 - 淼 Be Water"><meta property="og:description" content="Who is Wei Hong-Lin (Ivan Wei),一群人協作就是要測試一下
前言最近在公司導入 TDD，因此將這段程過記錄免得未來不記得怎麼設定。
先說我很愛 TDD (Test-driven development)，簡單幾點原因：

簡單化 -,"><link rel="stylesheet" href="/css/diaspora.css"><meta name="generator" content="Hexo 6.2.0"></head><body class="loading"><span id="config-title" style="display:none">淼 Be Water</span><div id="loader"></div><div id="single"><div id="top" style="display:block"><div class="bar" style="width:0"></div><a class="iconfont icon-home image-icon" href="javascript:;" data-url="https://blog.ivanwei.co"></a><div title="播放/暂停" class="iconfont icon-play"></div><h3 class="subtitle">喝杯 Mocha 輕鬆打造 Node.js 的 TDD 生產線</h3><div class="social"><div><div class="share"><a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a></div><div id="qr"></div></div></div><div class="scrollbar"></div></div><div class="section"><div class="article"><div class="main"><h1 class="title">喝杯 Mocha 輕鬆打造 Node.js 的 TDD 生產線</h1><div class="stuff"><span>七月 25, 2016</span><ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/Learn/" rel="tag">Learn</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/Nodejs/" rel="tag">Nodejs</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/Testing/" rel="tag">Testing</a></li></ul></div><div class="content markdown"><h2 id="一群人協作就是要測試一下"><a href="#一群人協作就是要測試一下" class="headerlink" title="一群人協作就是要測試一下"></a>一群人協作就是要測試一下</h2><p><img src="/images/2016/07/25/TESTING-123.png" alt="測試 測試 123"></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近在公司導入 TDD，因此將這段程過記錄免得未來不記得怎麼設定。</p><p>先說我很愛 TDD (<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%B5%8B%E8%AF%95%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91" title="Test-driven development">Test-driven development</a>)，簡單幾點原因：</p><ol><li>簡單化 - 執行對應指令既可確認 API 輸出入的正確性</li><li>清單化 - 每寫一個測試 &#x3D; Checklist 多一個確認項目</li><li>可重覆使用</li></ol><p>基於以上 3 點再撘配 <a target="_blank" rel="noopener" href="http://gruntjs.com/" title="Grunt">Grunt</a>、<a target="_blank" rel="noopener" href="http://gulpjs.com/" title=" Gulp">Gulp</a>、<a target="_blank" rel="noopener" href="https://webpack.github.io/" title="Webpack">Webpack</a> 做流程的控管，過去許多煩雜的事情都變得如此簡單，例如要 <a target="_blank" rel="noopener" href="http://eslint.org/" title="ESLint">ESLint</a> 檢查 code，通過再進行測試 API，最後產出 API 文件。</p><p>事前說明：</p><ol><li>本篇使用 <a target="_blank" rel="noopener" href="https://mochajs.org/" title="Mocha">Mocha</a> 實作 TDD</li><li>在公司分享的簡報連結放在文中最後的參考資料，需要的請內取</li></ol><span id="more"></span><h2 id="開始手動"><a href="#開始手動" class="headerlink" title="開始手動"></a>開始手動</h2><h3 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h3><h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><ol><li>執行 <code>npm init</code></li><li>執行 <code>npm install --save express</code></li><li>執行 <code>npm install --save-dev supertest should</code></li><li>執行 <code>npm install -g mocha</code></li></ol><h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><ol><li>執行 <code>git clone https://github.com/IvanWei/tdd-example-express.git</code></li><li>執行 <code>npm install</code></li><li>執行 <code>npm install -g mocha</code></li></ol><h3 id="架-express-Server"><a href="#架-express-Server" class="headerlink" title="架 express Server"></a>架 express Server</h3><ol><li>在根目錄新增一個 app.js 並將下面程式碼貼上後存儲</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">send</span>(<span class="string">&#x27;Hello World!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.<span class="title function_">createServer</span>(app)</span><br><span class="line">.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Example app listening on port 3000!&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ol start="2"><li>執行 <code>node app.js</code> 可以 Terminal 上可以看到下面的畫面，此時瀏覽器連 <code>localost:3000</code> 可以看見 Hello World! 既表示 HTTP 連線正確</li></ol><h3 id="設定-mocha"><a href="#設定-mocha" class="headerlink" title="設定 mocha"></a>設定 mocha</h3><ol><li>新增存放測試檔案的資料夾</li></ol><ul><li>Demo 將其存放在 <code>./test/spec</code> 裡，之後範例都會以這為主要路徑</li><li>沒建立過，可以下 <code>mkdir -p ./test/spec</code> 幫忙建立</li></ul><ol start="2"><li>在 <code>./test</code> 新增 <code>mocha.opts</code></li><li>設定 Timeout 時間、啟動時預先載入的 Library、app.js 等，以下是 Demo 的設定</li></ol><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">--timeout</span> 500000</span><br><span class="line"><span class="params">--require</span> should</span><br><span class="line"><span class="params">--reporter</span> spec</span><br><span class="line"><span class="params">--ui</span> bdd</span><br><span class="line"><span class="params">--recursive</span> <span class="string">./app.js</span></span><br></pre></td></tr></table></figure><ul><li>ui 採用 bdd 方式撰寫以使用情境為出發點，此處也可以換成 tdd，但接下來的 Demo 會以 bdd 方式進行</li></ul><h3 id="寫個測試試試"><a href="#寫個測試試試" class="headerlink" title="寫個測試試試"></a>寫個測試試試</h3><ol><li>設一個 Object 內容如下</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> contents = &#123;</span><br><span class="line">  <span class="attr">string</span>: <span class="string">&#x27;測試&#x27;</span>,</span><br><span class="line">  <span class="attr">number</span>: <span class="number">100</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol start="2"><li>測試條件如下，比對 contents 的型態和裡面的內容</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;contents is an Object,&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;contents have string and number fields.&#x27;</span>, <span class="function">(<span class="params">done</span>) =&gt;</span> &#123;</span><br><span class="line">    contents.<span class="property">should</span>.<span class="property">be</span>.<span class="property">an</span>.<span class="title class_">Object</span>();</span><br><span class="line">    contents.<span class="property">should</span>.<span class="property">have</span>.<span class="title function_">keys</span>(<span class="string">&#x27;string&#x27;</span>, <span class="string">&#x27;number&#x27;</span>);</span><br><span class="line">    contents.<span class="property">string</span>.<span class="property">should</span>.<span class="property">be</span>.<span class="title class_">String</span>();</span><br><span class="line">    contents.<span class="property">string</span>.<span class="property">should</span>.<span class="property">be</span>.<span class="title function_">equal</span>(<span class="string">&#x27;測試&#x27;</span>);</span><br><span class="line">    contents.<span class="property">number</span>.<span class="property">should</span>.<span class="property">be</span>.<span class="title class_">Number</span>().<span class="property">and</span>.<span class="title function_">equal</span>(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">done</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ol start="3"><li>執行 mocha 測試</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mocha test/spec/demo.spec.js</span><br></pre></td></tr></table></figure><p>執行完畢後會看到下面成功畫面</p><p><img src="/images/2016/07/25/TDD-SIMPLE-SUCCESS.png" alt="範列 TDD 成功"></p><ol start="4"><li>再來將 contents 的 number 改個值</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> contents = &#123;</span><br><span class="line">  <span class="attr">string</span>: <span class="string">&#x27;測試&#x27;</span>,</span><br><span class="line">  <span class="attr">number</span>: <span class="number">90</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol start="5"><li>再執行一次 mocha 進行測試，此時會看見 mocha 回傳的錯誤畫面</li></ol><p><img src="/images/2016/07/25/TDD-SIMPLE-FAILED.png" alt="範列 TDD 失敗"></p><p>以上就完成基本 mocha 的 TDD 測試。</p><p>如果要測試 Sequelize.js 和其他 Server 端的服務，測試方式和前面教得雷同，將上面的 contents 改為回傳的 result 即可。<br>接下來說明接口 API 的測試方式</p><h2 id="API-測試"><a href="#API-測試" class="headerlink" title="API 測試"></a>API 測試</h2><ol><li>安裝 supertest</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev supertest</span><br></pre></td></tr></table></figure><ol start="2"><li>app.js 加入 supertest，並設為 global</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="variable language_">global</span>.<span class="property">request</span> = <span class="built_in">require</span>(<span class="string">&#x27;supertest&#x27;</span>); <span class="comment">//不必在每個檔案都 require 一次</span></span><br><span class="line">request = <span class="title function_">request</span>(<span class="string">&#x27;http://localhost:&#x27;</span> + process.<span class="property">env</span>.<span class="property">PORT</span>); <span class="comment">// 設定 API 前面的主機位置</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">send</span>(<span class="string">&#x27;Hello World!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.<span class="title function_">createServer</span>(app)</span><br><span class="line">.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Example app listening on port 3000!&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ol start="3"><li>test&#x2F;spec&#x2F;demo.spec.js 加入 API 的測試</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Test API,&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;Demo.&#x27;</span>, <span class="function">(<span class="params">done</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    request.<span class="title function_">get</span>(<span class="string">&#x27;/demo&#x27;</span>).<span class="title function_">end</span>(<span class="function">(<span class="params">err, res</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">done</span>(err); <span class="comment">// 與 Server 相關錯誤</span></span><br><span class="line">      <span class="keyword">if</span> (res.<span class="property">statusCode</span> !== <span class="number">200</span>) <span class="keyword">return</span> <span class="title function_">done</span>(res.<span class="property">body</span>); <span class="comment">// 與 API 有關的錯誤</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> result = res.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">      result.<span class="property">should</span>.<span class="property">be</span>.<span class="title class_">Object</span>();</span><br><span class="line">      result.<span class="property">should</span>.<span class="property">have</span>.<span class="title function_">keys</span>(<span class="string">&#x27;message&#x27;</span>);</span><br><span class="line">      result.<span class="property">message</span>.<span class="property">should</span>.<span class="property">be</span>.<span class="title function_">equal</span>(<span class="string">&#x27;Use API!&#x27;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">done</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ol start="4"><li>執行 mocha 測試，這次會多一個 API 的測試結果</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mocha test/spec/demo.spec.js</span><br></pre></td></tr></table></figure><p>註：API 測試和實際前端送 request 的方式相同，主要歸功於 <a target="_blank" rel="noopener" href="https://github.com/visionmedia/supertest" title="supertest">supertest</a>。</p><p><img src="/images/2016/07/25/TDD-SIMPLE-API-SUCCESS.png" alt="API 測試"></p><h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ol><li><a target="_blank" rel="noopener" href="http://joe-dev.blogspot.tw/2014/06/tdd-is-dead.html" title="懶人包：TDD is Dead 戰文總整理">懶人包：TDD is Dead 戰文總整理</a></li><li><a target="_blank" rel="noopener" href="http://www.slideshare.net/Ivan_wei/getting-started-with-tdd-63869156" title="Getting started with TDD  (公司分享的簡報)">Getting started with TDD (公司分享的簡報)</a></li><li><a target="_blank" rel="noopener" href="https://thewayofcode.wordpress.com/2013/04/21/how-to-build-and-test-rest-api-with-nodejs-express-mocha/" title="How to build and test your Rest API with Node.js, Express and Mocha ...">How to build and test your Rest API with Node.js, Express and Mocha …</a></li></ol><!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]--><audio id="audio" loop preload="auto" controls data-autoplay="false"><source type="audio/mpeg" src=""></audio><ul id="audio-list" style="display:none"><li title="0" data-url="/music/See_You_On_The_Otherside_The_126ers.mp3"></li></ul></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>作者: </strong>Wei Hong-Lin (Ivan Wei)</li><li class="post-copyright-title"><strong>文章標題: </strong>喝杯 Mocha 輕鬆打造 Node.js 的 TDD 生產線</li><li class="post-copyright-link"><strong>文章連結: </strong><a href="/zh-tw/2016-07-25-getting-started-with-expressjs/" target="_blank" title="喝杯 Mocha 輕鬆打造 Node.js 的 TDD 生產線">https://blog.ivanwei.co/zh-tw/2016-07-25-getting-started-with-expressjs/</a></li><li class="post-copyright-license"><strong>版權聲明: </strong><a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a></li></ul><div></div></div></div></div></div></div></body><script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script><script src="/js/plugin.js"></script><script src="/js/typed.js"></script><script src="/js/diaspora.js"></script><link rel="stylesheet" href="/photoswipe/photoswipe.css"><link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css"><script src="/photoswipe/photoswipe.min.js"></script><script src="/photoswipe/photoswipe-ui-default.min.js"></script><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button> <button class="pswp__button pswp__button--share" title="Share"></button> <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button> <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button> <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-PTEVL7FF0X"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-PTEVL7FF0X")</script></html>